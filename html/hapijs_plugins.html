				<section>
					<h2>a delightful journey into <br/>commonly used hapijs plugins</h2>
					<p>
						<small>Created by Lloyd Benson / lloyd.benson@gmail.com</small>
					</p>
				</section>
                                <section>
                                        <h3>whoami</h3>
<p>
                                        <ul>
                                        <li>lloyd benson (lloyd.benson@gmail.com)</li>
                                        <li>https://github.com/lloydbenson</li>
                                        <li>architect @walmartlabs node team</li>
                                        <li>many hats (devops/sysadmin/developer/gluer)</li>
                                        <li>the guy that did the black friday node release</li>
                                        </ul>
</p>
                                </section>
				<section>
					<p>hapi plugins</p>
					<ul>
						<li>lab</li>
						<li>rejoice</li>
						<li>confidence</li>
						<li>good</li>
						<li>joi</li>
						<li>lout</li>
						<li><a href="https://github.com/hapijs">https://github.com/hapijs</a> (core)</li>
						<li><a href="https://hapijs.com/plugins">https://hapijs.com/plugins</a> (community)</li>
					</ul>
				</section>
				<section>
					<p>lab</p>
					<ul>
						<li>lab is a command line utility</li>
						<li>refactored mocha to handle most simple use cases</li>
						<li><a href="https://github.com/hapijs/lab">https://github.com/hapijs/lab</a></li>
					</ul>
				</section>
				<section>
					<p>code</p>
					<ul>
						<li>code is an assertion library</li>
						<li>direct rewrite of chai</li>
						<li>you can use chai with lab</li>
						<li><a href="https://github.com/hapijs/code">https://github.com/hapijs/code</a></li>
					</ul>
				</section>
				<section>
					<p>whats wrong with chai?</p>
					<ul>
						<li>subset of functions</li>
						<li>all functions (so no missed assertions)</li>
					</ul>
				</section>
				<section>
					<p>simple test</p>
					<pre><code data-trim contenteditable>
var Lab = require('lab');
var Code = require('code');

var lab = exports.lab = Lab.script();
var expect = Code.expect;
var describe = lab.describe;
var it = lab.it;

describe('math', function () {

    it('returns true when 1 + 1 equals 2', function (done) {

        expect(1+1).to.equal(2);
        done();
    });
});
					</code></pre>
				</section>
				<section>
					<p>functions</p>
					<pre><code data-trim contenteditable>
Lab.expect(object).to.equal();
Lab.expect(object).to.not.equal();
Lab.expect(object).to.deep.equal();
Lab.expect(object).to.exist();
Lab.expect(object).to.not.exist();
					</code></pre>
				</section>
				<section>
					<p>command line</p>
					<pre><code data-trim contenteditable>

-r - reporter (default console)
     console,html,junit,lcov,tap,json,clover
-m - individual test timeout in milliseconds (default 2s)
-t - minimum coverage threshold percentage (default 100%)
-g - global leak check (default)
-v - verbose 
-i - individual tests (e.g. 1-2 or 1,3)
-p - run tests in parallel
-L - built-in hapijs linter
-a - assert library tallies assertions
					</code></pre>
				</section>
				<section>
					<p>package.json</p>
					<pre><code data-trim contenteditable>
  "scripts": {
    "test": "lab -a code -r html -L -t 100 -m 10000"
  },
					</code></pre>
				</section>
				<section>
					<p>server.inject()</p>
					<ul>
						<li>uses shot module (<a href="https://github.com/hapijs/shot">https://github.com/hapijs/shot</a>)</li>
						<li>injects itself in http layer without network stack</li>
						<li>no worrying about port conflicts</li>
					</ul>
<br/>
<img src="/images/hapijs/shot.png" height=70 style="border:none; background:none; box-shadow:none;"/>
				</section>
				<section>
					<p>prepareServer example</p>
					<pre><code data-trim contenteditable>
internals.prepareServer = function (callback) {

  var server = new Hapi.Server();
  server.connection();
  server.register({
    register: require('..'),
    options: internals.defaults
  }, function (err) {

    expect(err).to.not.exist();
    callback(server);
  });
};
					</code></pre>
				</section>
				<section>
					<p>server.inject() example</p>
					<pre><code data-trim contenteditable>
it('POST /route', function (done) {

  internals.prepareServer(function (server) {
    var options = {
      method: 'POST',
      url: '/route',
      payload: {
        name: 'name',
        description: 'description'
      }
    };
    server.inject(options, function (response) {
      //console.log(response);
      expect(response.statusCode).to.equal(302);
      done();
    });
  });
});
					</code></pre>
				</section>
				<section>
					<p>code coverage</p>
					<ul>
						<li>hapijs projects have 100% code coverage</li>
						<li>less than 100% coverage...</li>
					</ul>
				</section>
				<section>
<img src="/images/hapijs/partialcoverage.png" style="border:none; background:none; box-shadow:none;"/>
				</section>
				<section>
					<p>rejoice</p>
					<ul>
						<li>cli utility for starting up hapi via a json config file</li>
						<li>replaces bin/hapi</li>
						<li>rejoice -c app.json</li>
						<li>based on composer (<a href="https://github.com/hapijs/glue">https://github.com/hapijs/glue</a>)</li>
						<li><a href="https://github.com/hapijs/rejoice">https://github.com/hapijs/rejoice</a></li>
					</ul>
				</section>
				<section>
					<p>rejoice example</p>
					<pre><code data-trim contenteditable>
{
  "connections": [
    { "port": 8080, "labels": [ "api", "http" ] },
    { "port": 8999, "labels": [ "admin" ] }
  ],
  "plugins": {
    "good": {
      "reporters": [{
        "reporter": "good-console",
          "args": [{ "response": "*", "error": "*" }]
      }]
    },
    "lout": {}
  }
}
					</code></pre>
				</section>
				<section>
					<p>confidence</p>
					<ul>
						<li>configuration document format</li>
						<li>foundation for A/B (not covered)</li>
						<li>useful when combined with rejoice</li>
					</ul>
<br/>
<img src="/images/hapijs/confidence.png" height=60 style="border:none; background:none; box-shadow:none;"/>
				</section>
				<section>
					<p>document format example</p>
					<pre><code data-trim contenteditable>
{
    "key1": "abc",
    "key2": {
        "$filter": "env",
        "production": {
            "deeper": {
                "$value": "value"
            }
        },
        "$default": {
            "$filter": "platform",
            "android": 0,
            "ios": 1,
            "$default": 2
        }
    },
    "key3": {
        "sub1": 123,
        "sub2": {
            "$filter": "xfactor",
            "yes": 6
        }
    },
    "ab": {
        "$filter": "random.a",
        "$range": [
            { "limit": 10, "value": 4 },
            { "limit": 20, "value": 5 }
        ],
        "$default": 6
    },
    "$meta": {
        "description": "example file"
    }
}
					</code></pre>
				</section>
				<section>
					<p>no filter</p>
					<pre><code data-trim contenteditable>
{
    "key1": "abc",
    "key2": 2,
    "key3": {
        "sub1": 123
    },
    "ab": 6
}
					</code></pre>
				</section>
				<section>
					<p>filter</p>
					<pre><code data-trim contenteditable>
{
    "env": "production",
    "platform": "ios",
    "xfactor": "yes",
    "random": {
        "a": 15
    }
}
					</code></pre>
					<pre><code data-trim contenteditable>
{
    "key1": "abc",
    "key2": {
        "deeper": "value"
    },
    "key3": {
        "sub1": 123,
        "sub2": 6
    },
    "ab": 5
}
					</code></pre>
				</section>
				<section>
					<p>command line</p>
					<pre><code data-trim contenteditable>confidence -c app-confidence.json --filter.env=prod > app.json</code></pre>
					<pre><code data-trim contenteditable>rejoice -c app.json</code></pre>
				</section>
				<section>
					<p>good</p>
					<ul>
						<li>now with configurable reporters!</li>
						<li>good-file, good-http, good-console, good-broadcast</li>
						<li>log types of request, ops, log(custom), error</li>
					</ul>
<br/>
<img src="/images/hapijs/good.png" height=75 style="border:none; background:none; box-shadow:none;"/>
				</section>
				<section>
					<p>additional good options</p>
<ul>
<li>TRY OUT</li>
<li>opsInterval (default 15s)</li>
<li>headers</li>
<li>responsePayload</li>
<li>requestPayload</li>
<li>increases size and may impact security</li>
</ul>
                                       </ul>
				</section>
				<section>
					<p>good-console reporter</p>
					<pre><code data-trim contenteditable>

var options = {
    opsInterval: 1000,
    reporters: [{
        reporter: require('good-console'),
        args:[{ log: '*', response: '*' }]
    }]
};

                                        </code></pre>
					<pre><code data-trim contenteditable>
example output
                                        </code></pre>
				</section>
				<section>
					<p>good-file reporter</p>
					<pre><code data-trim contenteditable>
var options = {
  reporters: [{
    reporter: require('good-file'),
    args: ['./test/fixtures/awesome_log', { ops: '*' }]
  }]
};

server.register(require('good-file'), options, function (err) {
  if (!err) {
    // Plugin loaded successfully
  }
});
                                        </code></pre>
				</section>
				<section>
					<p>good-http reporter</p>
					<pre><code data-trim contenteditable>
var options = {
  reporters: [{
    reporter: require('good-http'),
    args: ['http://prod.logs:3000', { error: '*' } , {
      threshold: 20,
      wreck: {
        headers: { 'x-api-key' : 12345 }
      }
    }]
  }]
};

server.register(require('good-http'), options, function (err) {
  if (!err) {
    // Plugin loaded successfully
  }
});
                                        </code></pre>
				</section>
				<section>
					<p>good-broadcast utility</p>
<ul>
<li>cli utility</li>
<li>separates it out from your other process</li>
<li>adds envelop (DESCRIBE MORE)</li>
</ul>
                                       </ul>
				</section>
				<section>
					<p>good-broadcast example</p>
					<pre><code data-trim contenteditable>
{
    "url": "http://server/analytics",
    "log": "/log/request_services.log",
    "interval": 1000,
    "newOnly": true,
    "resumePath": "/log/requestIndex.tmp",
    "wait": 1000,
    "attempts": 1
}
					</code></pre>
					<pre><code data-trim contenteditable>
broadcast -c broadcast.json
                                        </code></pre>
				</section>
				<section>
					<p>custom reporter</p>
					<ul>
						<li>make your own custom reporter at</li>
						<li>https://github.com/hapijs/good-reporter (UPDATE)</li>
						<li>community and hapijs reporters at</li>
                                                <li>https://github.com/hapijs/good</li>
					</ul>
				</section>
				<section>
					<p>joi</p>
					<ul>
						<li>2 step process</li>
                                                <li>define schema</li>
                                                <li>then validate the schema</li>
                                                <li>joi used useful in non-hapi projects</li>
                                                <li>built-in helpers for hapi</li>
                                                <li>response validation</li>
					</ul>
<br/>
<img src="/images/hapijs/joi.png" height=75 style="border:none; background:none; box-shadow:none;"/>
				</section>
				<section>
					<p>define schema</p>
					<pre><code data-trim contenteditable>
var Joi = require('joi');
var schema = {
  a: Joi.string()
};
					</code></pre>
				</section>
				<section>
					<p>validate schema</p>
					<p>If the value is valid, null is returned, otherwise an Error object.</p>
					<pre><code data-trim contenteditable>
var err = Joi.validate({ a: 'a string' }, schema);
					</code></pre>
				</section>
				<section>
					<p>joi example</p>
					<pre><code data-trim contenteditable>
var schema = {
  username: Joi.string().alphanum().min(3).max(30).with('birthyear').required(),
  password: Joi.string().regex(/[a-zA-Z0-9]{3,30}/).without('access_token'),
  access_token: [Joi.string(), Joi.number()],
  birthyear: Joi.number().integer().min(1900).max(2013),
  email: Joi.string().email()
};
// err === null -> valid
var err = Joi.validate({ username: 'abc', birthyear: 1994 }, schema);
					</code></pre>
				</section>
				<section>
					<p>joi within hapi</p>
					<pre><code data-trim contenteditable>
server.route({
  method: 'GET',
  path: '/hello',
  config: {
    handler: handler,
    validate: {
      query: {
        id: Joi.number().min(100).required().xor('username'),
        username: Joi.string().alphanum().min(3).max(10)
      }
    }
  }
});
					</code></pre>
				</section>
				<section>
					<p>schema</p>
					<ul>
						<li>Keys are optional by default</li>
                                                <li>Strings are utf-8 encoded by default</li>
                                                <li>Rules are defined in an additive fashion and evaluated in order after whitelist and blacklist checks</li>
					</ul>
				</section>
				<section>
					<p>schema object types</p>
					<pre><code data-trim contenteditable>
var schema = Joi.string().min(10);

var schema = Joi.object({
    a: Joi.string()
});
					</code></pre>
				</section>
				<section>
					<p>validate</p>
					<pre><code data-trim contenteditable>
 validate(value, schema, options) 
					</code></pre>
				</section>
				<section>
					<p>schema functions by types</p>
					<ul>
                                        <li>any()</li>
                                        <li>array()</li>
                                        <li>boolean()</li>
                                        <li>date()</li>
                                        <li>func()</li>
                                        <li>number()</li>
                                        <li>object(schema)</li>
                                        <li>string()</li>
					</ul>
				</section>
				<section>
					<p>schema functions any()</p>
<center>
<table>
<tr>
<td>
<ul>
<li>.allow(value)</li>
<li>.valid(value)</li>
<li>.invalid(value)</li>
<li>.required()</li>
<li>.optional()</li>
<li>.with(peer)</li>
<li>.without(peer)</li>
<li>.description(desc)</li>
</ul>
</td>
<td>
<ul>
<li>.xor(peer)</li>
<li>.or(peer)</li>
<li>.notes(notes)</li>
<li>.tags(tags)</li>
<li>.options(options)</li>
<li>.strict()</li>
<li>.rename(to, [options])</li>
</ul>
</td>
</tr>
</table>
</center>
				</section>
				<section>
					<p>schema functions array()</p>
					<ul>
<li>.includes(type)</li>
<li>.excludes(type)</li>
<li>.min(limit)</li>
<li>.max(limit)</li>
<li>.length(limit)</li>
					</ul>
				</section>
				<section>
					<p>schema functions boolean()</p>
					<ul>
 					<li>supports the same methods as any() type</li>
					</ul>
					<pre><code data-trim contenteditable>
var boolean = Joi.boolean();
boolean.allow(null);
var err = boolean.validate(true);
					</code></pre>
				</section>
				<section>
					<p>schema functions number()</p>
					<ul>
<li>.min(limit)</li>
<li>.max(limit)</li>
<li>.integer()</li>
					</ul>
				</section>
				<section>
					<p>schema functions string()</p>
					<ul>
<li>.insensitive()</li>
<li>.min(limit)</li>
<li>.max(limit)</li>
<li>.length(limit)</li>
<li>.regex(pattern)</li>
<li>.alphanum()</li>
<li>.token()</li>
<li>.guid()</li>
<li>.email()</li>
					</ul>
				</section>
				<section>
					<p>schema functions date()</p>
					<ul>
<li>date.min(date)</li>
<li>date.max(date)</li>
					</ul>
				</section>
				<section>
					<p>schema functions func()</p>
					<ul>
 					<li>supports the same methods as any() type</li>
					</ul>
					<pre><code data-trim contenteditable>
var func = Joi.func();
func.allow(null);
var err = func.validate(function () {});
					</code></pre>
				</section>
				<section>
					<p>helpful tips</p>
					<pre><code data-trim contenteditable>
// empty string
any.allow('')
					</code></pre>
					<pre><code data-trim contenteditable>
// conditional
any.when('key',
  { is: 'val',
    then: Joi.required(),
    otherwise: Joi.allow('').optional()
  }
)
					</code></pre>
					</ul>
				</section>
				<section>
					<p>lout</p>
					<ul>
						<li>automate your documentation</li>
						<li>use describe in your routes</li>
                                                <li>register plugin</li>
                                                <li>use describe in joi to document schema</li>
                                                <li>http://server/docs</li>
					</ul>
<br/>
<img src="/images/hapijs/lout.png" height=65 style="border:none; background:none; box-shadow:none;"/>
				</section>
				<section>
					<p>lout screenshot here</p>
<img src="/images/hapijs/lout-ss.png" style="border:none; background:none; box-shadow:none;"/>
				</section>
                                <section>
                                        <h3>Questions / Comments</h3>
                                        <p>
                                                <small>Created by Lloyd Benson / lloyd.benson@gmail.com</small>
                                        </p>
                                        <p>
                                                <a href="http://github.com/lloydbenson/presentations"><small>http://github.com/lloydbenson/presentations</small></a>
                                        </p>
                                </section>
